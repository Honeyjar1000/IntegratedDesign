<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Pi Cam + Dual Motor</title>
<style>
  body{font-family:system-ui;margin:0;background:#111;color:#eee}
  #v{max-width:640px;width:100%;display:block;margin:16px auto;border:1px solid #333;border-radius:8px}
  .wrap{max-width:900px;margin:0 auto;padding:0 16px;text-align:center}
  .kbd{display:inline-block;border:1px solid #555;border-radius:6px;background:#222;padding:3px 8px;margin:0 2px}
  button{background:#2b2b2b;color:#eee;border:1px solid #444;border-radius:10px;padding:10px 14px;margin:6px;cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:center;gap:24px;">
      <div>
        <h3>Original Feed</h3>
        <img id="v" src="" alt="Live video">
      </div>
      <div>
        <h3>Annotated Feed</h3>
        <img id="annotated" src="" alt="Annotated video">
      </div>
    </div>
      <span class="kbd">↑</span> forward,
      <span class="kbd">↓</span> reverse,
      <span class="kbd">←</span> pivot left,
      <span class="kbd">→</span> pivot right. Release = stop.</p>
    <div>
      <button id="btnFwd">Forward (↑)</button>
      <button id="btnRev">Reverse (↓)</button>
      <button id="btnL">Pivot Left (←)</button>
      <button id="btnR">Pivot Right (→)</button>
      <button id="btnStop">Stop</button>
    </div>
    <pre id="status">L: dir 0 duty 0.00 | R: dir 0 duty 0.00</pre>
  </div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
async function postJSON(url, body){
  const res = await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body||{}) });
  return res.json();
}
function updateStatus(j){
  const el = document.getElementById("status");
  if(!el) return;
  if(j && j.ok){
    const L = j.left || {dir:0,duty:0}, R = j.right || {dir:0,duty:0};
    const fmt = x => (typeof x==="number" ? x.toFixed(2) : x);
    el.textContent = `L: dir ${L.dir} duty ${fmt(L.duty)} | R: dir ${R.dir} duty ${fmt(R.duty)}`;
  } else if(j && j.error){
    el.textContent = `error: ${j.error}`;
  }
}
async function drive(left, right){ updateStatus(await postJSON("/drive", {left, right})); }
async function stop(){ updateStatus(await postJSON("/stop", {})); }

document.getElementById("btnFwd").addEventListener("click", ()=>drive(1, 1));
document.getElementById("btnRev").addEventListener("click", ()=>drive(-1, -1));
document.getElementById("btnL").addEventListener("click", ()=>drive(-1, 1));
document.getElementById("btnR").addEventListener("click", ()=>drive(1, -1));
document.getElementById("btnStop").addEventListener("click", stop);

// Keyboard: send once on keydown, stop on keyup
const pressed = new Set();
window.addEventListener("keydown", (e)=>{
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) e.preventDefault();
  if(pressed.has(e.code)) return;  // ignore auto-repeat
  pressed.add(e.code);
  if(e.code==="ArrowUp") drive(1, 1);
  if(e.code==="ArrowDown") drive(-1, -1);
  if(e.code==="ArrowLeft") drive(-1, 1);
  if(e.code==="ArrowRight") drive(1, -1);
});
window.addEventListener("keyup", (e)=>{
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) e.preventDefault();
  pressed.delete(e.code);
  // if no arrow keys are held, stop
  const anyHeld = ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].some(k => pressed.has(k));
  if(!anyHeld) stop();
});

// Optional: periodic status
setInterval(async ()=>{
  try{
    const r = await fetch("/status"); updateStatus(await r.json());
  }catch{}
}, 3000);

const socket = io();
socket.on('video_frame', function(msg) {
  document.getElementById('v').src = "data:image/jpeg;base64," + msg.data;
});
socket.on('annotated_frame', function(msg) {
  document.getElementById('annotated').src = "data:image/jpeg;base64," + msg.data;
});
</script>
</body>
</html>