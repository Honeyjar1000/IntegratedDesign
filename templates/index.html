<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pi Cam + Motor Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background:#111; color:#eee; }
    header { padding: 12px 16px; background:#181818; position: sticky; top: 0; }
    main { padding: 16px; display:grid; gap:16px; }
    .row { display:flex; gap:16px; flex-wrap: wrap; align-items: flex-start; }
    .panel { background:#1c1c1c; border:1px solid #2a2a2a; border-radius:12px; padding:16px; }
    #video { max-width: 640px; width: 100%; border-radius: 8px; border:1px solid #333; }
    .kbd { display:inline-block; padding:4px 8px; border:1px solid #555; border-radius:6px; background:#222; }
    button { background:#2b2b2b; color:#eee; border:1px solid #444; border-radius:10px; padding:10px 14px; cursor:pointer; }
    button:active { transform: translateY(1px); }
    .status { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <header>
    <strong>Pi Camera + Motor</strong>
  </header>

  <main>
    <div class="row">
      <div class="panel">
        <img id="video" src="/video_feed" alt="Live video" />
        <div style="margin-top:8px; font-size:14px; color:#bbb">
          Tip: Click anywhere on the page to give it focus, then use
          <span class="kbd">↑</span> / <span class="kbd">↓</span> to drive.
        </div>
      </div>

      <div class="panel" style="min-width:260px; flex:1;">
        <h3 style="margin-top:0">Controls</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnFwd">Forward (↑)</button>
          <button id="btnRev">Reverse (↓)</button>
          <button id="btnStop">Stop</button>
        </div>

        <h4>Status</h4>
        <div id="status" class="status">dir: 0, duty: 0.00</div>
      </div>
    </div>
  </main>

  <script>
    // --- Helpers to POST JSON to Flask endpoints ---
    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      return res.json();
    }

    async function cmdForward() {
      lastCmd = "fwd";
      try {
        const j = await postJSON("/motor", { dir: "fwd" });
        updateStatus(j);
      } catch (e) { console.error(e); }
    }

    async function cmdReverse() {
      lastCmd = "rev";
      try {
        const j = await postJSON("/motor", { dir: "rev" });
        updateStatus(j);
      } catch (e) { console.error(e); }
    }

    async function cmdStop() {
      lastCmd = "stop";
      try {
        const j = await postJSON("/motor/stop", {});
        updateStatus(j);
      } catch (e) { console.error(e); }
    }

    function updateStatus(j) {
      const el = document.getElementById("status");
      if (!el) return;
      if (j && j.ok) {
        const dir = ("dir" in j) ? j.dir : 0;
        const duty = ("duty" in j) ? j.duty : 0;
        el.textContent = `dir: ${dir}, duty: ${duty.toFixed ? duty.toFixed(2) : duty}`;
      } else if (j && j.error) {
        el.textContent = `error: ${j.error}`;
      }
    }

    // --- UI buttons ---
    document.getElementById("btnFwd").addEventListener("click", cmdForward);
    document.getElementById("btnRev").addEventListener("click", cmdReverse);
    document.getElementById("btnStop").addEventListener("click", cmdStop);

    // --- Keyboard handling ---
    // We only send a command when key goes down (first time), then stop on keyup.
    // Ignore OS key-repeat by tracking a pressed set.
    const pressed = new Set();
    let lastCmd = "stop";

    window.addEventListener("keydown", (e) => {
      if (e.code === "ArrowUp" || e.code === "ArrowDown") e.preventDefault();
      if (pressed.has(e.code)) return; // ignore repeats
      pressed.add(e.code);

      if (e.code === "ArrowUp") {
        cmdForward();
      } else if (e.code === "ArrowDown") {
        cmdReverse();
      }
    });

    window.addEventListener("keyup", (e) => {
      if (e.code === "ArrowUp" || e.code === "ArrowDown") {
        e.preventDefault();
        pressed.delete(e.code);
        // If neither arrow is held, stop
        if (!pressed.has("ArrowUp") && !pressed.has("ArrowDown")) {
          cmdStop();
        }
      } else {
        pressed.delete(e.code);
      }
    });

    // Optional: poll status every few seconds to reflect any server-side changes
    async function pollStatus() {
      try {
        const res = await fetch("/motor/status");
        const j = await res.json();
        updateStatus(j);
      } catch {}
    }
    setInterval(pollStatus, 2500);
  </script>
</body>
</html>
